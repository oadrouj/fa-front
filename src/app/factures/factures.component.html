<p-confirmDialog [style]="{width: '50vw', height: '100%'}" [baseZIndex]="10000" rejectButtonStyleClass="p-button-text">
</p-confirmDialog>
<p-toast [style]="{marginTop: 'marginTop'}" styleClass="styleClass"></p-toast>

<div class="main pt-4">
    <div class="grid  mx-0 ">
        <div class="leftSection md:col-12 p-0 positon-relative">
            <div class="pl-3">
                <div class="header flex justify-content-between align-items-start">
                    <div class="flex  flex-wrap align-items-baseline">
                        <img src="assets/img/FacturesLogo.png" class="mr-3" />
                        <h1 class="title color-orange">FACTURES</h1>
                    </div>

                    <button pButton (click)="newDevis()" class="bg-orange btn-new-devis text-normal" label="Nouvelle Facture"></button>

                </div>
                <p class="subtitle pt-2">Visualisez, modifiez et gérez toutes vos factures !</p>

                <span class="p-input-icon-left mt-2">
                    <i class="pi pi-search"></i>
                    <input pInputText [(ngModel)]="searchText"
                        (input)="emitFilterEvent('filterByInput', $event.target.value)"
                        class="searchInput" placeholder="Rechercher ici" />
                </span>

                <div class="flex align-items-center pt-4 filterContainer">
                    <p-autoComplete [(ngModel)]="selectedClient" placeholder="Client" [suggestions]="clientSuggestions" (completeMethod)="clientAutoCompleteSearch($event)"></p-autoComplete>
                    <p-calendar [(ngModel)]="selectedDate"></p-calendar>
                    <p-dropdown [options]="echeanceOptions" [(ngModel)]="selectedEcheance" placeholder="Echéance" [showClear]="false"></p-dropdown>
                    <p-inputNumber [(ngModel)]="selectedMontant" placeholder="Montant"></p-inputNumber>
                    <p-dropdown [options]="statutOptions" [(ngModel)]="selectedStatut" placeholder="Statut" [showClear]="false"></p-dropdown>
                    <button pButton pRipple (click)="emitFilterEvent('filterByButton', $event.target.value)" class="filterBtn p-button-rounded  ml-2" label="Filtrer" icon="pi pi-filter"></button>
                </div>
            </div>

            <app-table #dt1 [tableData]="devisList" [cols]="cols" [currency]="Currency" [styleClass]="'table'" (selectionChange)="selectionChange($event)" [styleId]="'devisList'" [loadLazy]="loadLazy" [events]="eventsSubject.asObservable()" [filterEvent]="filterSubject.asObservable()"
                [globalFilterFields]="['reference','client','date_emission','echeance','total_ttc','statut']">
            </app-table>

            <div class="devisTotal flex justify-content-between align-items-center w-100">
                <span class="color-gray ">Total TTC</span>
                <span class="color-gray">{{montantTTCAllDevis | number:'1.2-2' }} {{' ' + Currency}}</span>
            </div>
        </div>

        <div class="rightSection md:col-12 p-0">
            <div class="devis-details">
                <div class="header flex justify-content-between">
                    <p-splitButton class=" border-radius-6" label="Brouillon" [model]="statusItems"></p-splitButton>
                    <div class="flex">
                        <button pButton label="Télécharger" class="p-button-text"></button>
                        <button pButton label="Imprimer" class="p-button-text"></button>
                        <button pButton label="Dupliquer" class="p-button-text" (click)="duplicateDevis()"></button>
                        <button pButton label="Modifier" class="p-button-text" (click)="editDevis()"></button>
                        <button pButton label="Supprimer" class="p-button-text" (click)="deleteDevis()"></button>
                    </div>
                </div>
                <div class="content pt-4 px-3">
                    <div class="grid px-1">
                        <div class="col-5 pt-1">
                            <img src="assets/img/logo.png" alt="">
                        </div>
                        <div class="col-7 text-right">
                            <h1>Facture {{selectedDevisItem.reference}}</h1>
                            <p class="date my-2">Date d'émission: {{selectedDevisItem.date_emission | date:'shortDate'}}
                            </p>
                            <p class="date my-1">Date d'échéqnce: {{getDateEcheance | date:'shortDate'}}</p>
                        </div>
                    </div>
                    <div class="grid px-2 py-4">
                        <div class="col-6 grid flex-column">
                            <span class="color-gray">Pour:</span>
                            <span>Omar Attioui</span>
                            <span>12 rue de Casablanca</span>
                            <span>Casablanca 2000</span>
                            <span>Maroc</span>
                            <span class="mt-3">06 69 99 99</span>
                        </div>
                        <div class="col-6 align-items-center grid flex-column">
                            <span class="color-gray">De</span>
                            <span>FACTURI</span>
                        </div>
                    </div>

                </div>


                <p-table [columns]="DevisContentItemsCols" [value]="selectedDevisItem.contentItems">
                    <ng-template pTemplate="header" let-yourColumnArrayVaraible>
                        <tr>
                            <ng-container *ngFor="let colVar of yourColumnArrayVaraible">
                                <th [colSpan]="colVar.colspan">
                                    {{colVar.header}}
                                </th>
                            </ng-container>

                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-yourRowVaraible let-yourColumnArrayVaraible="columns">
                        <tr>
                            <ng-container *ngFor="let colVar of yourColumnArrayVaraible">
                                <ng-container [ngSwitch]="colVar.type">
                                    <ng-container *ngSwitchCase="'date'">
                                        <td [colSpan]="colVar.colspan">
                                            {{yourRowVaraible[colVar.field] | date:'shortDate'}}
                                        </td>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'currency'">
                                        <td [colSpan]="colVar.colspan" mode="decimal">
                                            {{yourRowVaraible[colVar.field] | number:'1.2-2' }} {{' ' + Currency}}
                                        </td>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'pourcentage'">
                                        <td [colSpan]="colVar.colspan">
                                            {{yourRowVaraible[colVar.field] + '%'}}
                                        </td>
                                    </ng-container>

                                    <ng-container *ngSwitchDefault>
                                        <td [colSpan]="colVar.colspan">
                                            {{yourRowVaraible[colVar.field]}}
                                        </td>
                                    </ng-container>

                                </ng-container>

                            </ng-container>

                        </tr>
                    </ng-template>
                    <ng-template pTemplate="summary" let-yourColumnArrayVaraible>

                        <div class="grid">
                            <div class="col-md-7">
                                <span>MONTANT TOTAL HT</span>
                            </div>
                            <div class="col-xl-5">
                                <span>{{this.summaryTotalHT | number:'1.2-2' }} {{' ' + Currency}}</span>
                            </div>
                        </div>

                        <div class="grid">
                            <div class="col-7">
                                <span>REMISE</span>
                            </div>
                            <div class="col-5">
                                <span>{{this.selectedDevisItem.remise | number:'1.2-2' }} {{' ' + Currency}}</span>
                            </div>
                        </div>

                        <div class="grid ">
                            <div class="col-7">
                                <span>TVA</span>
                            </div>
                            <div class="col-5">
                                <span>{{this.summaryTVA | number:'1.2-2' }} {{' ' + Currency}}</span>
                            </div>
                        </div>

                        <hr>

                        <div class="grid">
                            <div class="col-7">
                                <span>TOTAL ESTIME TTC</span>
                            </div>
                            <div class="col-5">
                                <span>{{this.selectedDevisItem.montant_ttc | number:'1.2-2' }} {{' ' + Currency}}</span>
                            </div>
                        </div>

                    </ng-template>

                </p-table>


            </div>
        </div>
    </div>
</div>


<!-- Dialog -->
<app-factures-dialog [visible]="displayDialog" (closeDialog)="displayDialog = false" [clientAutoCompleteSearch]="clientAutoCompleteSearch" [SelectDevisItemEvent]="notifySelectedDevisChanged.asObservable()" [dialogStatusEvent]="dialogStatusEvent.asObservable()">
</app-factures-dialog>